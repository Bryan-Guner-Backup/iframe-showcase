<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>README</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
</head>
<body>
<h1 id="pug-walk">pug-walk</h1>
<p>Walk and transform a Pug AST</p>
<p><a href="https://travis-ci.org/pugjs/pug-walk"><img src="https://img.shields.io/travis/pugjs/pug-walk/master.svg" alt="Build Status" /></a> <a href="https://david-dm.org/pugjs/pug?path=packages/pug-walk"><img src="https://david-dm.org/pugjs/pug/status.svg?path=packages/pug-walk" alt="Dependencies Status" /></a> <a href="https://david-dm.org/pugjs/pug?path=packages/pug-walk&amp;type=dev"><img src="https://david-dm.org/pugjs/pug/dev-status.svg?path=packages/pug-walk" alt="DevDependencies Status" /></a> <a href="https://www.npmjs.org/package/pug-walk"><img src="https://img.shields.io/npm/v/pug-walk.svg" alt="npm version" /></a> <a href="https://codecov.io/gh/pugjs/pug-walk/branch/master"><img src="https://img.shields.io/codecov/c/github/pugjs/pug-walk/master.svg" alt="Coverage Status" /></a></p>
<h2 id="installation">Installation</h2>
<pre><code>npm install pug-walk</code></pre>
<h2 id="usage">Usage</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">var</span> walk <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pug-walk&#39;</span>)<span class="op">;</span></a></code></pre></div>
<h3 id="walkast-before-after-options"><code>walk(ast, before, after, options)</code></h3>
<p>Traverse and optionally transform a <a href="https://github.com/pugjs/pug-ast-spec">Pug AST</a>.</p>
<p><code>ast</code> is not cloned, so any changes done to it will be done directly on the AST provided.</p>
<p><code>before</code> and <code>after</code> are functions with the signature <code>(node, replace)</code>. <code>before</code> is called when a node is first seen, while <code>after</code> is called after the children of the node (if any) have already been traversed.</p>
<p>The <code>replace</code> parameter is a function that can be used to replace the node in the AST. It takes either an object or an array as its only parameter. If an object is specified, the current node is replaced by the parameter in the AST. If an array is specified and the ancestor of the current node allows such an operation, the node is replaced by all of the nodes in the specified array. This way, you can remove and add new nodes adjacent to the current node. Whether the parent node allows array operation is indicated by the property <code>replace.arrayAllowed</code>, which is set to true when the parent is a Block and when the parent is a Include and the node is an IncludeFilter.</p>
<p>If <code>before</code> returns <code>false</code>, the children of this node will not be traversed and left unchanged (unless <code>replace</code> has been called). Otherwise, the returned value of <code>before</code> is ignored. The returned value of <code>after</code> is always ignored. If <code>replace()</code> is called in <code>before()</code> with an array, and <code>before()</code> does not return <code>false</code>, the nodes in the array are still descended.</p>
<p><code>options</code> can contain the following properties:</p>
<ul>
<li><code>includeDependencies</code> (boolean): Walk the AST of a loaded dependent file (i.e., includes and extends). Defaults to <code>false</code>.</li>
<li><code>parents</code> (array<Node>): Nodes that are ancestors to the current <code>ast</code>. This option is used mainly internally, and users usually do not have to specify it. Defaults to <code>[]</code>.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">var</span> lex <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pug-lexer&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">var</span> parse <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pug-parser&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="co">// Changing content of all Text nodes</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="co">// ==================================</span></a>
<a class="sourceLine" id="cb3-6" title="6"></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">var</span> source <span class="op">=</span> <span class="st">&#39;.my-class foo&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="kw">var</span> dest <span class="op">=</span> <span class="st">&#39;.my-class bar&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="kw">var</span> ast <span class="op">=</span> <span class="at">parse</span>(<span class="at">lex</span>(source))<span class="op">;</span></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12">ast <span class="op">=</span> <span class="at">walk</span>(ast<span class="op">,</span> <span class="kw">function</span> <span class="at">before</span>(node<span class="op">,</span> replace) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-13" title="13">  <span class="cf">if</span> (<span class="va">node</span>.<span class="at">type</span> <span class="op">===</span> <span class="st">&#39;Text&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-14" title="14">    <span class="va">node</span>.<span class="at">val</span> <span class="op">=</span> <span class="st">&#39;bar&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16">    <span class="co">// Alternatively, you can replace the entire node</span></a>
<a class="sourceLine" id="cb3-17" title="17">    <span class="co">// rather than just the text.</span></a>
<a class="sourceLine" id="cb3-18" title="18">    <span class="co">// replace({ type: &#39;Text&#39;, val: &#39;bar&#39;, line: node.line });</span></a>
<a class="sourceLine" id="cb3-19" title="19">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-21" title="21">  <span class="dt">includeDependencies</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-23" title="23"></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="at">parse</span>(<span class="at">lex</span>(dest))<span class="op">,</span> ast)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-25" title="25"></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co">// Convert all simple &lt;strong&gt; elements to text</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="co">// ============================================</span></a>
<a class="sourceLine" id="cb3-28" title="28"></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="kw">var</span> source <span class="op">=</span> <span class="st">&#39;p abc #[strong NO]</span><span class="sc">\n</span><span class="st">strong on its own line&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="kw">var</span> dest <span class="op">=</span> <span class="st">&#39;p abc #[| NO]</span><span class="sc">\n</span><span class="st">| on its own line&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-31" title="31"></a>
<a class="sourceLine" id="cb3-32" title="32"><span class="kw">var</span> ast <span class="op">=</span> <span class="at">parse</span>(<span class="at">lex</span>(source))<span class="op">;</span></a>
<a class="sourceLine" id="cb3-33" title="33"></a>
<a class="sourceLine" id="cb3-34" title="34">ast <span class="op">=</span> <span class="at">walk</span>(ast<span class="op">,</span> <span class="kw">function</span> <span class="at">before</span>(node<span class="op">,</span> replace) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-35" title="35">  <span class="co">// Find all &lt;strong&gt; tags</span></a>
<a class="sourceLine" id="cb3-36" title="36">  <span class="cf">if</span> (<span class="va">node</span>.<span class="at">type</span> <span class="op">===</span> <span class="st">&#39;Tag&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">node</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&#39;strong&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-37" title="37">    <span class="kw">var</span> children <span class="op">=</span> <span class="va">node</span>.<span class="va">block</span>.<span class="at">nodes</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-38" title="38"></a>
<a class="sourceLine" id="cb3-39" title="39">    <span class="co">// Make sure that the Tag only has one child -- the text</span></a>
<a class="sourceLine" id="cb3-40" title="40">    <span class="cf">if</span> (<span class="va">children</span>.<span class="at">length</span> <span class="op">===</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> children[<span class="dv">0</span>].<span class="at">type</span> <span class="op">===</span> <span class="st">&#39;Text&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-41" title="41">      <span class="co">// Replace the Tag with the Text</span></a>
<a class="sourceLine" id="cb3-42" title="42">      <span class="at">replace</span>(<span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> children[<span class="dv">0</span>].<span class="at">val</span><span class="op">,</span> <span class="dt">line</span><span class="op">:</span> <span class="va">node</span>.<span class="at">line</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-43" title="43">    <span class="op">}</span></a>
<a class="sourceLine" id="cb3-44" title="44">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-45" title="45"><span class="op">},</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-46" title="46">  <span class="dt">includeDependencies</span><span class="op">:</span> <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-47" title="47"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-48" title="48"></a>
<a class="sourceLine" id="cb3-49" title="49"><span class="va">assert</span>.<span class="at">deepEqual</span>(<span class="at">parse</span>(<span class="at">lex</span>(dest))<span class="op">,</span> ast)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-50" title="50"></a>
<a class="sourceLine" id="cb3-51" title="51"><span class="co">// Flatten blocks</span></a>
<a class="sourceLine" id="cb3-52" title="52"><span class="co">// ==============</span></a>
<a class="sourceLine" id="cb3-53" title="53"></a>
<a class="sourceLine" id="cb3-54" title="54"><span class="kw">var</span> ast <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-55" title="55">  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Block&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-56" title="56">  <span class="dt">nodes</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb3-57" title="57">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;a&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-58" title="58">    <span class="op">{</span></a>
<a class="sourceLine" id="cb3-59" title="59">      <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Block&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-60" title="60">      <span class="dt">nodes</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb3-61" title="61">        <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;b&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-62" title="62">        <span class="op">{</span></a>
<a class="sourceLine" id="cb3-63" title="63">          <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Block&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-64" title="64">          <span class="dt">nodes</span><span class="op">:</span> [ <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;c&#39;</span> <span class="op">}</span> ]</a>
<a class="sourceLine" id="cb3-65" title="65">        <span class="op">},</span></a>
<a class="sourceLine" id="cb3-66" title="66">        <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;d&#39;</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb3-67" title="67">      ]</a>
<a class="sourceLine" id="cb3-68" title="68">    <span class="op">},</span></a>
<a class="sourceLine" id="cb3-69" title="69">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;e&#39;</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb3-70" title="70">  ]</a>
<a class="sourceLine" id="cb3-71" title="71"><span class="op">};</span></a>
<a class="sourceLine" id="cb3-72" title="72"></a>
<a class="sourceLine" id="cb3-73" title="73"><span class="kw">var</span> dest <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb3-74" title="74">  <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Block&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb3-75" title="75">  <span class="dt">nodes</span><span class="op">:</span> [</a>
<a class="sourceLine" id="cb3-76" title="76">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;a&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-77" title="77">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;b&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-78" title="78">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;c&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-79" title="79">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;d&#39;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb3-80" title="80">    <span class="op">{</span> <span class="dt">type</span><span class="op">:</span> <span class="st">&#39;Text&#39;</span><span class="op">,</span> <span class="dt">val</span><span class="op">:</span> <span class="st">&#39;e&#39;</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb3-81" title="81">  ]</a>
<a class="sourceLine" id="cb3-82" title="82"><span class="op">};</span></a>
<a class="sourceLine" id="cb3-83" title="83"></a>
<a class="sourceLine" id="cb3-84" title="84"><span class="co">// We need to use `after` handler instead of `before`</span></a>
<a class="sourceLine" id="cb3-85" title="85"><span class="co">// handler because we want to flatten the innermost</span></a>
<a class="sourceLine" id="cb3-86" title="86"><span class="co">// blocks first before proceeding onto outer blocks.</span></a>
<a class="sourceLine" id="cb3-87" title="87"></a>
<a class="sourceLine" id="cb3-88" title="88">ast <span class="op">=</span> <span class="at">walk</span>(ast<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">function</span> <span class="at">after</span>(node<span class="op">,</span> replace) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-89" title="89">  <span class="cf">if</span> (<span class="va">node</span>.<span class="at">type</span> <span class="op">===</span> <span class="st">&#39;Block&#39;</span> <span class="op">&amp;&amp;</span> <span class="va">replace</span>.<span class="at">arrayAllowed</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb3-90" title="90">    <span class="co">// Replace the block with its contents</span></a>
<a class="sourceLine" id="cb3-91" title="91">    <span class="at">replace</span>(<span class="va">node</span>.<span class="at">nodes</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-92" title="92">  <span class="op">}</span></a>
<a class="sourceLine" id="cb3-93" title="93"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb3-94" title="94"></a>
<a class="sourceLine" id="cb3-95" title="95"><span class="va">assert</span>.<span class="at">deepEqual</span>(dest<span class="op">,</span> ast)<span class="op">;</span></a></code></pre></div>
<h2 id="license">License</h2>
<p>MIT</p>
</body>
</html>
